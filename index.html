<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactoryCast Pro - Player</title>
    <style>
        :root { --schneider-green: #3dcd58; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; color: white; overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif; }
        #container { display: flex; width: 100vw; height: 100vh; position: relative; }
        .slide { position: absolute; width: 100%; height: 100%; display: flex; opacity: 0; transition: opacity 1.5s ease-in-out; }
        .slide.active { opacity: 1; }
        .segment { flex: 1; height: 100%; object-fit: contain; background: #000; }
        #ui-layer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; }
        #progress-bar { height: 6px; background: var(--schneider-green); width: 0%; transition: width 0.1s linear; }
        #status-bar { background: rgba(0,0,0,0.7); padding: 8px 15px; font-size: 14px; display: flex; justify-content: space-between; border-top: 1px solid #444; }
        .sync-tag { color: var(--schneider-green); font-weight: bold; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="ui-layer">
        <div id="progress-bar"></div>
        <div id="status-bar">
            <div id="info-point">Chargement...</div>
            <div id="info-sync">Dernière MàJ : <span class="sync-tag" id="last-sync">--:--</span></div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const canal = params.get('canal') || Object.keys(config)[0];
        let config = {};
        let siteIndex = 0;

        async function fetchConfig() {
            const r = await fetch(`config.json?nocache=${Date.now()}`);
            config = await r.json();
        }

        async function play() {
            await fetchConfig();
            const sites = config[canal].sites;
            if (!sites || sites.length === 0) {
                document.getElementById('info-point').innerText = "Aucun site configuré.";
                return;
            }

            const currentSite = sites[siteIndex];
            const container = document.getElementById('container');
            
            // Création du nouveau slide
            const slide = document.createElement('div');
            slide.className = 'slide';
            
            const numSegments = currentSite.split || 1;
            for(let i=0; i<numSegments; i++) {
                const img = new Image();
                const suffix = numSegments > 1 ? `_p${i}` : '';
                img.src = `displays/${canal}_${siteIndex}${suffix}.png?v=${Date.now()}`;
                img.className = 'segment';
                slide.appendChild(img);
            }

            // Transition
            container.innerHTML = '';
            container.appendChild(slide);
            setTimeout(() => slide.classList.add('active'), 50);

            // UI Update
            document.getElementById('info-point').innerText = `POINT : ${canal} | Dashboard ${siteIndex + 1}/${sites.length}`;
            document.getElementById('last-sync').innerText = currentSite.last_update_str || 'N/A';

            // Timer Rotation
            let duration = (currentSite.duration || 15) * 1000;
            let start = Date.now();
            let timer = setInterval(() => {
                let elapsed = Date.now() - start;
                document.getElementById('progress-bar').style.width = (elapsed / duration * 100) + '%';
                if(elapsed >= duration) {
                    clearInterval(timer);
                    siteIndex = (siteIndex + 1) % sites.length;
                    play(); // Re-boucle
                }
            }, 100);
        }

        play();
    </script>
</body>
</html>