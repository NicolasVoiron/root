<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Display Schneider</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #3e4042; }
        #viewer { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; transition: opacity 1s; }
        #msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #3dcd58; font-family: sans-serif; text-align: center; }
    </style>
</head>
<body>
    <div id="msg">Chargement des données GitHub...</div>
    <div id="viewer"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const canal = params.get('canal') || 'bureau';
        let images = [];
        let index = 0;

        async function init() {
            try {
                // On force la lecture du fichier local sur le serveur GitHub
                const res = await fetch('config.json?nocache=' + Math.random());
                const config = await res.json();
                
                if (config.channels[canal]) {
                    images = config.channels[canal].sites.map((s, i) => ({
                        url: `docs/screens/${canal}_${i}.png?t=` + Math.random(),
                        dur: (s.display_time || 30) * 1000
                    }));
                    document.getElementById('msg').style.display = 'none';
                    rotate();
                } else {
                    document.getElementById('msg').innerText = "Canal non trouvé : " + canal;
                }
            } catch (e) {
                document.getElementById('msg').innerText = "Erreur de connexion au serveur GitHub. Réessai dans 5s...";
                setTimeout(init, 5000);
            }
        }

        function rotate() {
            const v = document.getElementById('viewer');
            v.style.opacity = 0;
            setTimeout(() => {
                v.style.backgroundImage = `url('${images[index].url}')`;
                v.style.opacity = 1;
                let wait = images[index].dur;
                index = (index + 1) % images.length;
                setTimeout(rotate, wait);
            }, 1000);
        }

        init();
    </script>
</body>
</html>