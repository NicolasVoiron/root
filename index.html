<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>FactoryCast Public</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #viewer { display: flex; width: 100vw; height: 100vh; justify-content: center; align-items: center; }
        .pane { 
            height: 100vh; 
            flex: 1; 
            /* PROPORTIONNEL SANS DÉFORMATION */
            object-fit: contain; 
            background: #000;
        }
        #pb { position: fixed; bottom: 0; left: 0; height: 4px; background: #3dcd58; width: 0%; z-index: 100; }
        #info { position: fixed; bottom: 10px; right: 15px; color: rgba(255,255,255,0.3); font-size: 11px; }
    </style>
</head>
<body>
    <div id="viewer"></div>
    <div id="pb"></div>
    <div id="info">Sync...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const canal = params.get('canal') || 'point_1';
        let sites = [], idx = 0;

        async function load() {
            try {
                const r = await fetch(`config.json?t=${Date.now()}`);
                const d = await r.json();
                sites = d.channels[canal].sites;
                render();
            } catch(e) { setTimeout(load, 5000); }
        }

        function render() {
            if (!sites.length) return;
            const s = sites[idx];
            const v = document.getElementById('viewer');
            const p = document.getElementById('pb');
            
            v.innerHTML = '';
            for(let i=0; i<s.split; i++) {
                const img = document.createElement('img');
                img.className = 'pane';
                // CACHE BUSTING : ?v=timestamp pour forcer le rafraîchissement
                img.src = `docs/screens/${canal}_${idx}_p${i}.png?v=${Date.now()}`;
                v.appendChild(img);
            }

            document.getElementById('info').innerText = `Point: ${canal} | MàJ: ${s.last_update_str || '--'}`;
            
            p.style.transition = 'none'; p.style.width = '0%';
            setTimeout(() => {
                p.style.transition = `width ${s.display_time}s linear`;
                p.style.width = '100%';
            }, 50);

            setTimeout(() => {
                idx = (idx + 1) % sites.length;
                if(idx === 0) load(); else render();
            }, s.display_time * 1000);
        }

        load();
    </script>
</body>
</html>