<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactoryCast Display</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: #000; overflow: hidden; }
        #stage { 
            display: flex; 
            width: 100vw; 
            height: 100vh; 
            justify-content: center; 
            align-items: center;
        }
        .screen-part {
            flex: 1;
            height: 100vh;
            /* PROPORTIONNEL ET ETIRÉ AU MAXIMUM */
            object-fit: contain; 
            display: block;
        }
        #progress { position: fixed; bottom: 0; left: 0; height: 4px; background: #3dcd58; transition: width 0.1s linear; width: 0%; }
        #info { position: fixed; bottom: 10px; right: 10px; color: rgba(255,255,255,0.3); font-family: monospace; font-size: 10px; }
    </style>
</head>
<body>
    <div id="stage"></div>
    <div id="progress"></div>
    <div id="info">Initialisation...</div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const canal = params.get('canal') || 'point_1';
        let sites = [], currentIndex = 0;

        async function loadConfig() {
            try {
                // Anti-cache sur le JSON
                const res = await fetch(`config.json?t=${Date.now()}`);
                const data = await res.json();
                if (data.channels[canal]) {
                    sites = data.channels[canal].sites;
                    render();
                }
            } catch (e) { 
                document.getElementById('info').innerText = "Erreur config. Rechargement...";
                setTimeout(loadConfig, 5000); 
            }
        }

        function render() {
            if (sites.length === 0) return;
            const site = sites[currentIndex];
            const stage = document.getElementById('stage');
            const info = document.getElementById('info');
            const progress = document.getElementById('progress');

            // Nettoyage
            stage.innerHTML = '';
            
            // Création des images (une par split)
            for (let i = 0; i < site.split; i++) {
                const img = document.createElement('img');
                // ANTI-CACHE AGRESSIF : ?v= timestamp
                img.src = `docs/screens/${canal}_${currentIndex}_p${i}.png?v=${Date.now()}`;
                img.className = 'screen-part';
                stage.appendChild(img);
            }

            info.innerText = `Point: ${canal} | MàJ: ${site.last_update_str || 'N/A'}`;
            
            // Animation de la barre
            let start = Date.now();
            const duration = site.display_time * 1000;
            
            const timer = setInterval(() => {
                let elapsed = Date.now() - start;
                let percent = (elapsed / duration) * 100;
                progress.style.width = percent + '%';
                
                if (elapsed >= duration) {
                    clearInterval(timer);
                    currentIndex = (currentIndex + 1) % sites.length;
                    // On recharge la config à chaque rotation complète pour voir les changements de l'UI
                    if (currentIndex === 0) loadConfig(); 
                    else render();
                }
            }, 100);
        }

        loadConfig();
    </script>
</body>
</html>