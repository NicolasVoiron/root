var count = 0;
var card;
var THEMES;
var SECTORSERVICES;
var TASKMANAGERS;
var heigthsectionCardUsersToSelect = 0;

// Set the current card to use
function setCard( currentCard ) { card = currentCard; }

// Set the title of the card
function setCardTitle() {
  var title = card.title.replace( /"/g, '&quot;' );
  $( '#title' ).val( title );
}

// Title in header
function setCardTitlePopUp( titleHeader ) {
  $( '#popupUpdateCardTitle' ).html( titleHeader );
}

// Set the themes
function setThemes( theThemes ) { THEMES = theThemes; }

// THEMES input
function setInputThemes() {
  $( '#themes' ).html( '' );
  // Values
  var currentTheme = null;
  let thms = '';

  // recovery and creation of theme options
  var themes2 = [] ;

  Object.keys( THEMES ).forEach( id => {
    if ( typeof THEMES[ id ] != 'undefined' ) {
      themes2.push( {
        id: id,
        name: themes[ id ].name
      } ) ;
    }
    sortAlphaMyArray( themes2, 'name' ) ;
  } );

  let themesCard =  ( card && card.themes  ) ? card.themes : [];

  themes2.forEach( ( theme, index ) => {
    let name = theme.name;
    var selected = ( themesCard.includes( theme.id ) ) ? 'selected'  : null;
    selected = ( index == 0 && !selected ) ? 'selected' : selected;

    thms += `<option value="${theme.id}" style="text-align:left;" ${selected}>${name}</option>`;

    if ( selected ) {
      currentTheme = THEMES[ theme.id ];
      $( '#prinInformationContainerCard' ).css( { 'border': `10px solid ${currentTheme.color}` } );
    }
  } );

  $( '#themes' ).html( thms );

  $( '#themes' ).on( 'change', () => {
    let them = Object.keys( THEMES ).filter( el => {
      return el == $( '#themes' ).val();
    } );

    currentTheme = THEMES[ them[ 0 ] ];
    $( '#prinInformationContainerCard' ).css( { 'border': `10px solid ${currentTheme.color}` } );
  } );
}

// FREQUENCY input
function setInputFrequency() {
  // Valeurs
  $( '#frequency' ).html( '' );

  let cardFrecuency = ( card && card.frequency ) ? card.frequency : '';
  Object.keys( FREQUENCY_LABELS_OPTIONS ).forEach( ( label ) => {
    let selected = cardFrecuency == label ? 'selected' : '';
    let opt = `<option value="${label}" ${selected}>${FREQUENCY_LABELS_OPTIONS[ label ]}</option>`;
    $( '#frequency' ).append( opt );
  } );

}

// SR input
function setInputSR() {
  let status = false;
  if ( card.safetyRegulated ) { status = true; }
  $( 'input[name=safetyRegulated]' ).prop( 'checked', status );
}

function dateInFuture( date ) {
  // Verify date in future
  if ( Date.now() <= new Date( date ) ) return false;
  else return true;
}

// SECTOR / SERVICE input
function setInputSectorService( input = $( '#sector_service' ) ) {
  let sector_services = '';
  sortAlphaMyArray( SECTORSERVICES, 'name' );

  for ( var i = 0; i < SECTORSERVICES.length; i++ ) {
    var selected = card.uap_services.indexOf( SECTORSERVICES[ i ].name ) >= 0 ? 'selected' : '';
    var opt = `<option value="${SECTORSERVICES[ i ].name}" ${selected}>${SECTORSERVICES[ i ].name}</option>`;
    sector_services += opt;
  }

  $( input ).html( sector_services );
}

// Set SECTORSERVICES
function setSectorService( sector_service ) { SECTORSERVICES = sector_service; }

// Place input
function setInputPlace() { $( '#place' ).val( card.place ); }

// check for the users
function setUsersSelect( users, $this ) {
  $( '#sectionCardUsersToSelect' ).html( '' );
  if ( !$( $this ).is( ':checked' ) ) {
    $( $this ).val( 'off' );
    $( $this ).next().html( RESTRICTED );
    $( '.sectionCardUsersToSelect' ).css( {
      'border': '1px solid #00000036'
    } );

    changeSelectRandomUsers( users );
  } else {
    $( $this ).next().html( ALL );
    $( $this ).val( 'on' );
    $( '.sectionCardUsersToSelect' ).css( {
      'min-height': 0,
      'border': 'none'
    } );
    heigthsectionCardUsersToSelect = 0;
  }
}

// Mode of selection of users
function changeModeUser( e ) {
  if ( $( e ).is( ':checked' ) ) {
    $( e ).next().html( ALL );
    $( e ).val( 'on' );
  } else {
    $( e ).val( 'off' );
    $( e ).next().html( RESTRICTED );
  }
}

// Random users
async function changeSelectRandomUsers( users ) {
  let $elemContainer = $( '#sectionCardUsersToSelect' );
  let taskSelected   = $( '#listTaskManager' ).val();

  // GET taskmanager selected to add card
  const tskManagerSelected = new TaskManager( { _id: taskSelected } );
  await tskManagerSelected.load();

  let usersIdInTsk = tskManagerSelected.cfuser.map( e => e.id_user );

  usersIdInTsk.forEach( async e => {
    // GET all the users in the taskmanager selected
    const user = await User.getById( e );
    let checked = '';

    if ( users ) {
      let id_check = users.filter( id_el => { return id_el == e; } );
      if ( id_check.length > 0 ) { checked = 'checked'; }
    }

    let userElemHTML = $( `<div class="individualUser thUser ">
												<div class="container_user_image">
												</div>
												<div class="select_contain">
												 	<div class="chkContain" >
														<input type="checkbox" ${checked} class="form-check-input userRandom" name="userRandom" value="${user._id}" disabled>
													</div>
													<div class="name_contain">
														<p style="margin-left: 5px;">${user.lastname.toUpperCase()} ${user.firstname}</p>
													</div>
												</div>
											</div>` );

    let route = '/ressources/images/user_profile_man.jpg';

    if ( user.hasOwnProperty( 'avatar' ) && user.avatar ) {
      route = formatHTTPRoute( user.avatar );
    }


    let img = $( `<img src="${route}" alt="avatar">` ).css( {
      height: '100px',
      width: '100px'
    } );

    $( userElemHTML ).find( '.container_user_image' ).append( img );
    $( $elemContainer ).append( userElemHTML );

    $( userElemHTML ).on( 'click', e => {
      let check =  $( e.currentTarget ).find( '.form-check-input' );
      if ( $( check ).prop( 'checked' ) ) {
        check.removeProp( 'checked' );
      } else {
        check.prop( 'checked', true );
      }
    } );

    if ( heigthsectionCardUsersToSelect == 0 ) {
      heigthsectionCardUsersToSelect = $( '.sectionCardUsersToSelect' ).height() + 50;
    } else {
      heigthsectionCardUsersToSelect = $( '.sectionCardUsersToSelect' ).css( 'min-height' );
    }

    $( '.sectionCardUsersToSelect' ).css( { 'min-height': heigthsectionCardUsersToSelect } );

  } );
}

// return selected users data
function recolectFinalDataUsers( v ) {
  let temp = [];
  if ( v[ 'modeRandomUsers' ] == 'on' ) {}
  else {
    let listUserRandom = $( '.individualUser' ).find( '.userRandom' );
    let listIdsSelected = [];
    Array.from( listUserRandom ).forEach( e => {
      if ( $( e ).is( ':checked' ) ) {
        listIdsSelected.push( $( e ).val() );
      }
    } );
    temp = listIdsSelected;
  }
  v[ 'modeRandomUsers' ] = temp;
  delete v[ 'userRandom' ];
  return v;
}

// Check input
function createInputChecks( title, $table, $addTr ) {
  count++;
  let $tdcheckTest = $( `<td><input class="txtAdd checkText col-12" value="${title.replace( /"/g, '&quot;' )}"/></td>` );
  let $tdTrash     = $( '<td/>' );
  let $trash       = $( '<i class="fas fa-trash-alt"></i>' );
  let $tr          = $( '<tr/>' );

  $tr.append( $tdcheckTest );
  $tdTrash.append( $trash );
  $tr.append( $tdTrash );


  $( $table ).find( 'tbody' ).append( $tr );
  $( $tr ).insertBefore( $( $addTr ) );

  $trash.on( 'click', e => { deleteInputFunc( event, e.currentTarget ); } );
}

// TABLE
function setTaskManagers( theTaskManagers ) { TASKMANAGERS = theTaskManagers; }

// TABLE input
function setTaskManagerInput( choice, input = $( '#listTaskManager' )  ) {
  taskmanagers = '';
  let exit = false;

  for ( var i = 0; i < TASKMANAGERS.length; i++ ) {
    let opt = '';
    var selected = '';

    if ( params.taskmanagerid != 'undefined' ) {
      // If we are in a table

      if ( card ) {
        if ( String( TASKMANAGERS[ i ]._id ) == card.cftaskmanager_id ) {
          selected = 'selected';
        }
      } else {
        if ( TASKMANAGERS[ i ]._id == params.taskmanagerid ) {
          selected = 'selected';
        }
      }

      opt = `<option value="${TASKMANAGERS[ i ]._id}" ${selected}>${TASKMANAGERS[ i ].name}</option>`;

      // For the gral admin
      if ( admn ) {
        taskmanagers += opt;
      } else {
        let idSave = '';
        let result = verifAdminForTable( TASKMANAGERS[ i ] );

        if ( result != undefined ) {
          idSave = TASKMANAGERS[ i ]._id;
          taskmanagers += opt;
        }

        result = verifRedactorForTable( TASKMANAGERS[ i ] );
        if ( result != undefined ) {
          if ( idSave != TASKMANAGERS[ i ]._id ) {
            taskmanagers += opt;
          }
        }
      }
    } else {
      opt = `<option value="${TASKMANAGERS[ i ]._id}" ${selected}>${TASKMANAGERS[ i ].name}</option>`;
      // If we are in the main page
      if ( admn ) {
        taskmanagers += opt;
      } else {
        // By adminSpec
        let idSave = '';
        let result = verifAdminForTable( TASKMANAGERS[ i ] );

        if ( result != undefined ) {
          idSave = TASKMANAGERS[ i ]._id;
          taskmanagers += opt;
        }

        result = verifRedactorForTable( TASKMANAGERS[ i ] );

        if ( result != undefined ) {
          if ( idSave != TASKMANAGERS[ i ]._id ) {
            taskmanagers += opt;
          }
        }
      }
    }
  }

  $( input ).html( taskmanagers );
}

// Verify the admin of the table
function verifAdminForTable( table ) {
  if ( table.admin ) {
    if ( table.admin.length > 0 ) {
      let ret = table.admin.filter( idAdmnSpec => idAdmnSpec == userID );
      if ( ret[ 0 ] != undefined ) {
        return ret[ 0 ];
      }
    }
  }
  return;
}

// Verify redactor for the table
function verifRedactorForTable( table ) {
  if ( table.redactor ) {
    if ( table.redactor.length > 0 ) {
      let ret = table.redactor.filter( idRed => idRed == userID );
      return ret[ 0 ];
    }
  }
  return;
}

// Checkpoints and reactions
/**
 *
 * @param {new|null} action in order to know if is a new card
 * @returns
 */
async function setChecks( action ) {

  // Gallery
  const gallery = new Gallery();
  await gallery.init();

  $( '#checkpoints-list-table tbody' ).html( `
            <tr id="checkAddTr">
                <td>
                    <input class="checkText col-12" id="addInputCheck" placeholder="${NEW_CHECK}"/>
                </td>
                <td>
                <input type="button"  id="addCheckpoints" class="form-control input-right btnBlue addChecks" aria-describedby="inputGroupPrepend" value="+">
                </td>
    </tr>` );

  $( '#nok-reaction-list-table tbody' ).html( `
			<tr id="nnokAddTr">
				<td>
					<input class="checkText col-12" id="addInputNokReaction" placeholder="${NEW_REACTION}"/>
				</td>
				<td>
					<input type="button"  id="addNokReaction" class="form-control input-right btnBlue addChecks" aria-describedby="inputGroupPrepend" value="+">
				</td>   
			</tr>` );


  if ( action == 'new' ) {
    $( '#pictureCheckpointContainer' ).html( '' );
    $( '#pictureNokReactionContainer' ).html( '' );
    gallery.generateEmptyChooseFileInput( $( '#pictureCheckpointContainer' ) );
    gallery.generateEmptyChooseFileInput( $( '#pictureNokReactionContainer' ) );
    Evnt.emit( 'ChecksLoaded' );

    return;
  }

  // Checkpoints
  for ( let idx in card.checkpoints ) {
    createInputChecks( card.checkpoints[ idx ], $( '#checkpoints-list-table' ), $( '#checkAddTr' ) );
  }
  $( '#pictureCheckpointContainer' ).html( '' );
  const checkpointsFiles = card.picturesCheckpoints.map( f => gallery.getFileByFilenameForCards( f ) ).filter( f => f );

  // Create an element for each file and allow to change it
  checkpointsFiles
    .forEach( file => gallery.generateChooseFileInput( file, $( '#pictureCheckpointContainer' ) ) );

  gallery.generateEmptyChooseFileInput( $( '#pictureCheckpointContainer' ) );

  // Nok
  for ( let idx in card.nok ) {
    // Create an element for each file and allow to change it
    createInputChecks( card.nok[ idx ], $( '#nok-reaction-list-table' ), $( '#nnokAddTr' ) );
  }

  $( '#pictureNokReactionContainer' ).html( '' );

  const nokFiles =  card.picturesNok.map( f => gallery.getFileByFilenameForCards( f ) ).filter( f => f );
  // Create an element for each file and allow to change it
  nokFiles
    .forEach( file => gallery.generateChooseFileInput( file, $( '#pictureNokReactionContainer' ) ) );

  gallery.generateEmptyChooseFileInput( $( '#pictureNokReactionContainer' ) );

  Evnt.emit( 'ChecksLoaded' );
}

function deleteInputFunc( e, t ) {
  e.preventDefault();
  $( t ).parent().parent().remove();
}

let handlerZoom = function() {
  $( '#btnSandBowZoom' ).unbind( 'click', handlerZoom );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).removeClass( 'modal-initial' );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).addClass( 'modal-zoom' );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).addClass( 'transLeftZoom' );

  $( '#btnSandBowZoom' ).val( '>' );
  $( '#btnSandBowZoom' ).on( 'click', handlerInitial );

};

let handlerInitial = function() {
  $( '#btnSandBowZoom' ).unbind( 'click', handlerZoom );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).removeClass( 'modal-zoom' );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).addClass( 'modal-initial' );
  $( '#modal-bac-a-sable-confirm .modal-dialog' ).removeClass( 'transLeftZoom' );

  $( '#btnSandBowZoom' ).val( '<' );
  $( '#btnSandBowZoom' ).on( 'click', handlerZoom );
};

$( '#btnSandBowZoom' ).on( 'click', handlerZoom );

$( document ).mouseup( function( ) {
  try {
    $( '#date' ).Close();
  } catch ( err ) { /* empty */ }
} );

window.addEventListener( 'ChecksLoaded', function() {
  // ADD Checkpoint button
  $( '#addCheckpoints' ).on( 'click', function( e ) {
    e.preventDefault();
    if ( verifyChecksLength( $( '#addInputCheck' ), ADD_CHECK_VERIFY, 'check' ) ) {
      createInputChecks( $( '#addInputCheck' ).val(), $( '#checkpoints-list-table' ), $( '#checkAddTr' ) );
      $( '#addInputCheck' ).val( '' );
    }
  } );

  // Add NokReaction button
  $( '#addNokReaction' ).on( 'click', function( e ) {
    e.preventDefault();
    if ( verifyChecksLength( $( '#addInputNokReaction' ), ADD_REACTION_NOK_VERIFY, 'nok' ) ) {
      createInputChecks( $( '#addInputNokReaction' ).val(), $( '#nok-reaction-list-table' ), $( '#nnokAddTr' ) );
      $( '#addInputNokReaction' ).val( '' );
    }
  } );

} );

function verifyChecksLength( elem, txt, check ) {

  if ( $( elem ).val().length <= 0 ) {
    $( '#modalFieldsRequired' ).modal( 'show' );
    $( '#modalRequiredTitle' ).html( INVALID_LENGHT );
    $( '#modalFieldsRequired .modal-body p' ).html( txt );
    $( '.closeTitleModalLengthRequired, #modalFieldsRequired .btn-modal-ok' ).on( 'click', function() {
      $( '#modalFieldsRequired' ).modal( 'hide' );
    } );
    return false;
  };

  txt = `${INVALID_LENGTH_CHECKS} ${limitLengthChecks} ${CHARACTERES}`;
  if ( check == 'nok' ) txt = `${INVALID_LENGTH_CHECKS} ${limitLengthChecks} ${CHARACTERES}`;

  if ( $( elem ).val().length > limitLengthChecks ) {
    $( '#modalFieldsRequired' ).modal( 'show' );
    $( '#modalRequiredTitle' ).html( INVALID_LENGHT );
    $( '#modalFieldsRequired .modal-body p' ).html( txt )
    $( '.closeTitleModalLengthRequired, #modalFieldsRequired .btn-modal-ok' ).on( 'click', function() {
      $( '#modalFieldsRequired' ).modal( 'hide' );
    } );

    return false;
  }
  return true;
}

function checkLengthChecks( $this, $txt, msg ) {
  if ( $txt.length > limitLengthChecks ) {
    let txt = `${msg} ${limitLengthChecks} ${CHARACTERES}`;
    $findP = $( $this ).parent().find( 'p' );
    if ( $findP.length == 0 ) $( $this ).parent().append( `<p style="text-align : left; color: red" class="textErrorChecks">${txt}</p>` );
    return false;
  } else {
    $( $this ).parent().find( '.textErrorChecks' ).remove();
  }
  return true;
}

function verifChecks( el, card, valid, arr ) {
  if ( !card[ arr ] ) card[ arr ] = [];
  let $txt = $( el ).val();
  let checkVerif = true;

  if ( $txt.length > 0 && !card[ arr ].includes( $txt ) ) {
    checkVerif = checkLengthChecks( el, $txt, INVALID_LENGTH_NOK_REACTION );
  } else {
    $( el ).parent().find( '.textErrorChecks' ).remove();
  }
  valid = checkVerif ? valid : checkVerif;
  return {
    status: valid,
    text: $txt
  };
}

function createTypeControlChange() {
  let $divTypeRandom = $( '#randomContainer' );
  let $divTypeFrequency = $( '#frequencyModalContainer' );
  $( '#radioRandom' ).on( 'click', function() {
    $( $divTypeRandom ).show();
    $( $divTypeFrequency ).hide();
  } );

  $( '#radioFrequency' ).on( 'click', function() {
    $( $divTypeFrequency ).show();
    $( $divTypeRandom ).hide();

    let $frequencyRightForWeekDay = $( '#frequencyRightForWeekDay' );
    let $frequencyRightForMonthDay = $( '#frequencyRightForMonthDay' );
    $( '#radioForWeekDay' ).on( 'click', function() {
      $( $frequencyRightForWeekDay ).show();
      $( $frequencyRightForMonthDay ).hide();

      $( '.weekDaysChecksContainer input' ).each( function( idx, el ) {
        $( el ).prop( 'checked', true );
      } );
    } );

    $( '#radioForMonthDay' ).on( 'click', function() {
      $( $frequencyRightForMonthDay ).show();
      $( $frequencyRightForWeekDay ).hide();

      let checksContainer = $( $frequencyRightForMonthDay ).find( '.monthDaysChecksContainer' );
      let calendarDays = $( '<div class="calendarDays">' );
      $( checksContainer ).html( '' );
      $( checksContainer ).append( calendarDays );
      for ( let index = 1; index <= 31; index++ ) {
        const element = $( `<div class="form-check-month">
									<input class="form-check-input check checkmonth" type="checkbox" value="${index}" id="dayM${index}">
									<label class="form-check-label radioLabel labelmonth" for="dayM${index}">
										${index}
									</label>
								</div>` );

        $( calendarDays ).append( element );
      }
      let final_month =  $( `<div class="form-check-month">
								<input class="form-check-input check checkmonth" type="checkbox" value="0" id="dayM0">
								<label class="form-check-label radioLabel labelmonth" for="dayM0">
									${END_OF_THE_MONTH}
								</label>
							</div>` );
      $( checksContainer ).append( final_month );

    } );

    $( '#radioForWeekDay' ).trigger( 'click' );
  } );

  $( '#radioRandom' ).trigger( 'click' );
}

function setTypeControlChangeOfCard() {
  if ( !card ) {
    return;
  }

  const {
    frequencyDays,
    frequencyMonths,
    frequency
  } = card;


  const months_container = $( '#frequencyRightForMonth' );
  Object.keys( Card.frequencyMonths ).forEach( month => {
    months_container.find( `#${month}` ).prop( 'checked', frequencyMonths.includes( Card.frequencyMonths[ month ] ) );
  } );

  if ( frequency != Card.frequencyLabels.daily ) {
    $( '#radioRandom' ).trigger( 'click' );
    return;
  }

  $( '#radioFrequency' ).trigger( 'click' );

  if ( !frequencyDays || frequencyDays.length == 0 ) {
    return;
  }

  // Verify if the frequency is per week day
  const isForWeekDay = isNaN( parseInt( frequencyDays[ 0 ] ) );

  if ( isForWeekDay ) {
    $( '#radioForWeekDay' ).trigger( 'click' );
    $( '.weekDaysChecksContainer input' ).each( function( idx, el ) {
      $( el ).prop( 'checked', false );
    } );

    frequencyDays.forEach( day => $( `#${day}` ).prop( 'checked', true ) );

  } else {
    // Is for month day
    $( '#radioForMonthDay' ).trigger( 'click' );
    $( '.monthDaysChecksContainer input' ).each( function( idx, el ) {
      $( el ).prop( 'checked', false );
    } );

    let days = []; // Days in the week
    for ( let index = 0; index <= 31; index++ ) days.push( index );

    frequencyDays.forEach( day => $( `#dayM${day}` ).prop( 'checked', true ) );
  }

}

/**
 * Recolect data frequancy control
 * @returns {Object<{
 *  frequency: string,
 *  frequencyDays: [] | string[] | int[],
 *  frequencyMonths: int[]
 * }>}
 */
function recolectFinalDataControl() {
  if ( $( '#radioRandom' ).is( ':checked' ) ) {
    // Not daily frequency is checked
    return {
      frequency: Card.frequencyLabels[ $( '#frequency' ).val() ],
      frequencyDays: [],
      frequencyMonths: Object.values( Card.frequencyMonths )
    };
  }

  // Daily frequency is checked

  // == For Days ==
  const forWeekSelected = $( '#radioForWeekDay' ).is( ':checked' );
  const weekDaysValue = $( '.weekDaysChecksContainer' ).find( 'input:checkbox:checked' );
  const daysMonthValue = $( '.monthDaysChecksContainer' ).find( 'input:checkbox:checked' );

  let checks_checked = forWeekSelected ? weekDaysValue : daysMonthValue;

  let days = [];
  for ( let i = 0; i < checks_checked.length; i++ ) {
    const element = checks_checked[ i ];
    days.push( $( element ).val() );
  }

  // == For Months ==
  const monthsValues = $( '#frequencyRightForMonth' ).find( 'input:checkbox:checked' );

  let months = [];
  for ( let i = 0; i < monthsValues.length; i++ ) {
    const element = monthsValues[ i ];
    if ( Card.frequencyMonths.hasOwnProperty( $( element ).val() ) ) {
      months.push( Card.frequencyMonths[ $( element ).val() ] );
    }
  }

  return {
    frequency: Card.frequencyLabels.daily,
    frequencyDays: days,
    frequencyMonths: months
  };
}

